# 暗号掲示板

<details>
<summary>一言</summary>

まだ署名処理全くできてないんだが

</details>

## 概要
暗号掲示板は、簡単にいうと**投稿内容が暗号化された**匿名掲示板。
...掲示板よりチャットルームの方が近いかも。

投稿者は平文を任意の公開鍵によって暗号化し、暗号文を投稿する。
閲覧者は暗号文を秘密鍵によって復号し、平文を読む。
わざわざこんなことするのは、当然**ロマン**のため。

- 投稿者はアカウントなしで掲示板に投稿できる
- デフォルトで鍵を3つ用意する
- 鍵の識別にはハッシュを使う

掲示板にはトピックなどを設けず、全て同じスレッド（？）で管理する。

### 詳細

- Webアプリとして作る
- ZEN StudyのWebアプリコンテストに出したい
- 今度のLTで発表するかも...?

## 技術スタック
今回はNext.jsメインで進めようと思う。
あとホスティングはVercel。

- フロントエンド: Next.js
  - Tailwind CSS
- バックエンド: Hono
  - Next.jsのRoute Handlersと組み合わせる
  - `hono/vercel`にあるアダプターを使用
- 暗号化: Web Crypto API
  - 暗号化 / 復号: RSA-OAEP
  - 署名 / 検証: RSA-PSS
- ORM: Prisma

### 本番環境
- ホスティング: Vercel
- DB: Neon
- リポジトリ: GitHub

### 開発環境
- 開発サーバー: Next.js or Hono（APIのみ）
- DB: DockerのPostgreSQLイメージを使用

## 機能

### 掲示板
掲示板には、データベースに保存された各投稿が表示される。
このページ（パスは`/`）が暗号掲示板のメインとなる。

掲示板はページネーションで区分けする。
1ページは大体15個の投稿を表示する。

### 投稿
掲示板の下部についているボタンを押すと投稿フォームが開くので、そこに必要事項を入力すると投稿できる。

投稿は以下の要素を持っている。

- 暗号文
- 鍵のハッシュ
- 投稿日時
- 認証情報

また、投稿の本文は平文ではなく暗号文で保存する。
平文じゃロマンないし。

また、HTTPリクエストに平文が載ってしまうが、暗号化はサーバーサイドで行う。
これはAPIに暗号文以外のものを入れたくないため。

投稿処理は直でAPIにリクエストを送る予定。
この際HonoのRPCを活用する。（<= 使ってるだけ状態）

### 投稿を読む
投稿は暗号化されているので、それを秘密鍵によって復号する必要がある。

復号フェーズでは、新しく入力した秘密鍵で復号する。
この際UIをモーダルにしたい。

また、暗号掲示板では、同じ秘密鍵を復号するたびに手で入力することにする。
ここで保存しちゃったら保存先も面倒だし、何より復号してる感がない。

### デジタル署名での本人認証（仮）

Web Crypto APIはデジタル署名にも対応しているので、実装は不可能ではないと思う。

ただし、暗号掲示板では公開鍵暗号方式を採用予定。
よって、独自の鍵を使っている場合、その文章を解読できた時点で、送り先が正しいことが確定する。
だって秘密鍵ないと解読できないし。

だから、使い道があるとすれば投稿者の本人確認。
暗号文の投稿は公開鍵さえあれば誰でもできるので、こちらに認証ができることは価値あるかも。

### 実装しない機能

- 掲示板をトピックで分ける
- アカウントによる認証
- 通知
- 返信
  - めんどい
  - DBに返信のカラム入れるの忘れてた
  - マイグレーションのやり方わからん
- 鍵の投稿
  - めんどい
  - ないほうがわかりやすいまである

## 非機能要件的な

### IPアドレスの保存
なんか保存しとかないとまずそうな気がした。

一応特定の足がかりくらいは必要だと思うので、DBに何かを追加する処理とかはIPアドレスを保存する。

---

**追記 2025/1/11**

HonoでIPアドレスを取得するときは`ConnInfo`を使う。
しかしこいつ、なんと環境によって使う`getConnInfo`関数が違うという曲者である。

それぞれの環境では以下のモジュールからインポートすること。

- 本番（Vercel）: `hono/vercel`
- 開発（Bun）: `hono/bun`
  - Bunがない環境でこれを使うと、Next.jsでビルドしたときにエラーになる
  - => 動的インポートを活用~~してゴリ押す~~

### IPアドレスでの制限
まずいらないと思うけど、念の為実装する。

同一IPアドレスで以下を制限する。

- 投稿: 一日に60回
- 検証用鍵の追加: 1日に5回くらい？

## ページ
メインとなるページ以外にも、いくつか専用のページを用意する予定。

- `/`: 暗号掲示板本体
- `/about`: 初めてページを訪れた人のために、このサイトの説明をする
- `add-public`: 公開鍵と秘密鍵を生成する
- `add-sign`: 検証鍵をサーバーに追加し、認証が使えるようにする

## UIデザイン
[Figmaのデザインカンプ](https://www.figma.com/design/t7cTgBTew0sSKiOOKT6sZg/暗号掲示板?t=P15mOFCTjyjhQbwE-0)を参照。
結構かっこよくなった気がする。

## リンク
- [公開先](https://encrypted-board.vercel.app)
- [GitHub](https://github.com/nanasi-1/encrypted-board)
- [Vercel Project](https://vercel.com/nanasi-1s-projects/encrypted-board)

### 参考資料

- [CI / CDの解説本](https://zenn.dev/hayato94087/books/6a55108faa37ba/viewer/e020g4xk6s17t3v6)
- [DBの解説本](https://zenn.dev/hayato94087/books/94bf9a15a98684/viewer/f000ut2i2b1lk4a1)